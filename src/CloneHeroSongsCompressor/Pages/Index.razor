@page "/"
@using SongsCompressor.Common.Enums;
@using SongsCompressor.Common.Interfaces;
@inject NavigationManager Navigation
@inject IFolderPicker FolderPicker
@inject ICompressionManager CompressionHandler

<MudCard Class="mt-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h4">Song Directories</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
    <MudText Class="mb-4">Provide paths to folders where your Clone Hero songs are located at</MudText>
        <MudPaper hidden="@(Directories.Count < 1)">
        <MudList>
        @foreach (var directory in Directories)
        {
            <MudListItem @key="@directory">
                <MudText Class="d-flex justify-space-between flex-grow-1 gap-4">
                     <MudText Class="align-self-center">@directory</MudText> <MudIconButton OnClick="() => RemoveFolder(directory)" Icon="@Icons.Material.Filled.Delete" aria-label="delete"></MudIconButton>
                </MudText>              
            </MudListItem>
        }
        </MudList>
    </MudPaper>
    <MudButton Class="mt-6" HtmlTag="label"
        Variant="Variant.Filled"
        Color="Color.Primary"
        StartIcon="@Icons.Material.Filled.DriveFolderUpload"
        OnClick="() => PickFolder()"> Add new directory</MudButton>
    </MudCardContent>
</MudCard>

<MudCard Class="mt-4 mb-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h4">Options</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudText Class="mb-4">If you're uncertain about the purpose of an option, it's best to stick with the default setting</MudText>

@*      TODO: Needs to verify is it possible to get rid of calling StateHasChanged. Without it The MudFab for moving next disabled condition will not update*@
        <MudSwitch Converter="@(new OptionsEnumConverter(OptionsEnum.ConvertPngToJpg, Options))" Color="Color.Primary" CheckedChanged="(bool e) => StateHasChanged()">Convert PNG to JPG</MudSwitch>

        <MudSwitch Class="mt-3" Converter="@(new OptionsEnumConverter(OptionsEnum.ConvertAudioToOpus, Options))" Color="Color.Primary" CheckedChanged="(bool e) => StateHasChanged()">Convert Audio to Opus</MudSwitch>
        <MudSwitch Class="ml-12" Disabled="!Options.Contains(OptionsEnum.ConvertAudioToOpus)" Converter="@(new OptionsEnumConverter(OptionsEnum.ConvertAudioFromMp3, Options))" Color="Color.Secondary" CheckedChanged="(bool e) => StateHasChanged()">From MP3</MudSwitch>
        <MudSwitch Class="ml-12" Disabled="!Options.Contains(OptionsEnum.ConvertAudioToOpus)" Converter="@(new OptionsEnumConverter(OptionsEnum.ConvertAudioFromOgg, Options))" Color="Color.Secondary" CheckedChanged="(bool e) => StateHasChanged()">From OGG</MudSwitch>

        <MudSwitch Class="mt-3" Converter="@(new OptionsEnumConverter(OptionsEnum.CreateBackup, Options))" Color="Color.Warning" CheckedChanged="(bool e) => StateHasChanged()">Create backup</MudSwitch>
    </MudCardContent>
</MudCard>

<MudFab OnClick="() => Start()" Disabled="Options.Count == 0 || Directories.Count == 0 || _loading" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Start" Label="Start" />


@code
{
    private IList<OptionsEnum> Options { get; } = new List<OptionsEnum>()
    {
        //Put default options here
        OptionsEnum.ConvertPngToJpg,
        OptionsEnum.ConvertAudioToOpus,
        OptionsEnum.ConvertAudioFromMp3,
        OptionsEnum.ConvertAudioFromOgg
    };

    private IList<string> Directories { get; } = new List<string>();

    private bool _loading = false;

    private async Task PickFolder()
    {
        var path = await FolderPicker.PickFolder();

        if(!string.IsNullOrWhiteSpace(path) && !Directories.Contains(path))
            Directories.Add(path);
    }

    private void RemoveFolder(string directory)
    {
        Directories.Remove(directory);
    }

    private async Task Start()
    {
        _loading = true;
        await CompressionHandler.Initialize(Directories, Options);
        Navigation.NavigateTo("progress");
    }

    private class OptionsEnumConverter : BoolConverter<bool>
    {
        private OptionsEnum _option;
        private readonly IList<OptionsEnum> _optionsList;

        public OptionsEnumConverter(OptionsEnum option, IList<OptionsEnum> optionsList)
        {
            SetFunc = OnSet;
            GetFunc = OnGet;
            _option = option;
            _optionsList = optionsList;
        }

        private bool OnGet(bool? value)
        {
            try
            {
                if (value == true)
                {
                    if (!_optionsList.Contains(_option))
                        _optionsList.Add(_option);
                }


                if (value is false)
                {
                    if (_optionsList.Contains(_option))
                        _optionsList.Remove(_option);
                }

                return _optionsList.Contains(_option);
            }
            catch (Exception e)
            {
                UpdateGetError("Conversion error: " + e.Message);
                return false;
            }
        }

        private bool? OnSet(bool arg)
        {
            try
            {
                return _optionsList.Contains(_option);
            }
            catch (FormatException e)
            {
                UpdateSetError("Conversion error: " + e.Message);
                return null;
            }
        }
    }
}